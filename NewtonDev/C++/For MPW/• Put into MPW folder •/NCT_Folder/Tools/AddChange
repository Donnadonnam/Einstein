#	File:		AddChange##	Contains:	script to add changes to a window##	Usage:		AddChange window [version [commentFile [SkipHeaderInsert]]]##	Status:		AddChange may return the following status values:##					0		the change was added#					1		error#					2		the user canceled##				AddChange adds a change from the file, commentFile, to the window.#				The change is inserted after the Change History text. If no change history#				is found, a dialog is presented, allowing the user to add a blank header#				to the file. If no commentFile is passed, the comment field is left blank.#				The mark character is used to mark the change.##	Written by:	Darin Adler and scott douglass##	Copyright:	© 1988-1995 by Apple Computer, Inc., all rights reserved.##	Change History (maintain by hand, AddChange confuses itself by editing itself):##				 2/20/95	BJS		.fp (frame part files) are like .f#				 6/15/94	sad		fix not asking about file with no header but many revs#				 1/21/94	BJS		It's been '94 for about three weeks now; 'bout time to change#									the copyright stuff! (it's more flexible now!)#				  1/7/93	BJS		In SkipHeaderInsert mode, skip out if we don't find a header.#				  1/5/93	BJS		Happy New Year - descend into copyright hell.#				12/29/92	pjp		Adding optional 4th arguement, that, if present tells AddChange to#									simply continue if no Header is present (used when checking in via#									the command line).#				 8/25/92	BJS		Don’t offer to create a header if the file is#									relatively old and still doesn’t have one.#				 8/12/92	wrs		Recognize .y (yacc) files#				  8/4/92	sad		fix headers with empty StartComments and EndComments; remove Finder and EASE compatability stuff; fix broken replace#				  7/7/92	BJS		Don’t offer to create a header if we weren’t given a comment;#									silently ignore “maintain by hand” histories; do the copyright-#									updating stuff after checking for “maintain by hand”, to avoid#									messing up files like this one once a year.#				 6/26/92	pm		treat .f files the same as .c files#				 6/26/92	sad		change start/endcomments#				  5/7/92	wrs		.i files are now in assembly language#				 3/31/92	sad		if Echo then just use no redirection#				  1/2/92	JSM		Hey, it's 1992!  Time to fix this file again.#				12/13/91	JSM		Treat '.proto' files as C header files since they are#									used to define C function prototypes by the FontMgr.#				 9/10/91	JCM		Treat '.s' files as '.a' files for compatibility with 29K#									and UNIX#				 8/26/91	JCM		Build user initials correctly for hyphenated names#				 8/22/91	JSM		Be a little more intelligent about recognizing when the#									copyright is already correct to improve performance and#									minimize the chance of screwing up the file past the#									header.#				 8/22/91	JSM		Fix screwed up formatting which occurred when this file#									was checked in using itself.#				 8/20/91	JSM		OK, so it’s hard to be completely year independent,#									let’s at least work for 1991 correctly.  Also, don’t#									add “To Do:” line at the end of every new header.#				 8/20/91	FM		Fix to handle years after 1990#				 9/19/90	PN		Fix the header format#				 1/23/90	dba		put in tweaks for Finder (1990 and old Change Histories)#				12/28/89	dba		don’t put the user name in Written By:#				12/27/89	dba		added a case for .aii#				12/19/89	dba		fixed the .a and .p cases (fixed in BBS by Jeff Miller)#				12/18/89	dba		made it work with upper-case extensions#				12/11/89	dba		made it work with new headers#				11/17/89	dba		use WrapCommentText#				 11/9/89	dba		stopped using LastChange marker; invented mark characterSet CaseSensitive 0Set Exit 0# the following helps to debug until MPW sends echos to Dev:Console instead of Dev:StdErrIf {Echo}	Set somewhere ""Else	Set somewhere "∑ Dev:Null"EndBegin	Set Window "{1}"					# add change to this file (must be open window)	Set Version "{2}"					# use this version	Set Comment "{3}"					# get comment from this file (should not be open)	Set SkipHeaderInsert "{4}"			# if ≠ "" then skip section where Header is added if not present.	# get rid of obsolete marker	Unmark LastChange "{Window}"	# get short name of window	If "{Window}" =~ /:*([¬:]+:*)*([¬:]+.([a-z]+)®2)®1/		Set Short "{®1}"		Set Suffix {®2}	Else If "{Window}" =~ /:*([¬:]+:*)*([¬:]+)®1/		Set Short "{®1}"		Set Suffix ""	Else		Exit 1	End	If "{Suffix}" =~ /[chrfy]/ || "{Suffix}" =~ /cp/ || "{Suffix}" =~ /fp/ || "{Suffix}" =~ /proto/		# comments for C, C headers, Rez, Fram, Yacc, C++ and C prototypes used in Toolbox:FontMgr		Set StartComment	'/*'∂n		Set EndComment		∂n'*/'∂n		Set Leader			''	Else If "{Suffix}" =~ /p/		# comments for Pascal		Set StartComment	'{'∂n		Set EndComment		∂n'}'∂n		Set Leader			''	Else If "{Suffix}" =~ /[asi]/ || "{Suffix}" =~ /aii/	# comments for assembly language (Mac, 29K/UNIX and 6502)		Set StartComment	''		Set EndComment		''		Set Leader			';'	Else							# comments for shell scripts, Makefiles etc.		Set StartComment	''		Set EndComment		''		Set Leader			'#'	End	# find a change history	Set Found 0	Find • "{Window}"	Find /Change History ∂(most recent first∂):[ ∂t]*∂n{Leader}[ ∂t]*∂n/∆ "{Window}" && Set Found 1	If ¬{Found}		Replace /(Change History ∂(most recent first∂):)®1[ ∂t]*∂n/ ∂			"®1∂n{Leader}∂n" "{Window}" && Set Found 1	End	# If no change history was found, look for one that is supposed to be maintained manually.	If ¬{Found}		# If we find one, exit without messing with its history.		Find /Change History ∂(maintain by hand/ "{Window}" && Exit 0	End	# if we still haven’t found a change history, offer to add a new one.	If ¬{Found}		# Skip out if we don't want to bother with the header.		Exit If {SkipHeaderInsert}		If ("{Comment}" ≠ "")			# Only offer if we actually have a comment.			Exit 0 If ``Count -c "{{Comment}}"`` ≤ 2			# Only offer if the file is relatively new			Exit 0 If 3 < {Version}			Confirm -t "I can’t find a change history in “{Short}”. Do you want to add a header?"			Set ConfirmStatus {Status}			If {ConfirmStatus} == 5							# cancel: report this to the caller				Exit 2			Else If {ConfirmStatus} == 4					# no: don’t add the change				Exit 0			End												# yes: go on with life as usual		End		If "{Contents}" == ""			Set Contents "xxx put contents here xxx"		End		If "{Writers}" == ""			Set Writers "xxx put writers here xxx"		End		If "{Copyright}" == ""			If "`Date -a -d`" =~ /≈, (19[0-9][0-9])®1/				Set Copyright "© {®1} by Apple Computer, Inc., all rights reserved."			End		End		Find • "{Window}"		Echo "{StartComment}{Leader}∂tFile:∂t∂t{Short}∂n∂{Leader}∂n∂{Leader}∂tContains:∂t{Contents}∂n∂{Leader}∂n∂{Leader}∂tWritten by:∂t{Writers}∂n∂{Leader}∂n∂{Leader}∂tCopyright:∂t{Copyright}∂n∂{Leader}∂n∂{Leader}∂tChange History (most recent first):∂n∂{Leader}∂n∂{EndComment}" > "{Window}.§"		Find ∆(§∆:\'Change History (most recent first):'∂n{Leader}∂n\∆) "{Window}"	End	# concoct the change line for the change history	If "{Version}" == ""		Set Version ∂t∂t	Else		# add <> to version number		If "{Version}" =~ /[¬∂[<]≈/			Set Version "<{Version}>"		End		If "{Version}" =~ /?«5,»/			If "   {Version}" =~ /≈(????????)®1/				Set Version "{®1}"			End		Else			If "   {Version}" =~ /≈(????)®1/				Set Version "∂t{®1}"			End		End	End	If "  `Date -d -s`" =~ /≈(????????)®1/		Set ChangeDate "{®1}"	Else		Set ChangeDate "??/??/??"	End	If "{UserInitials}" == ""			# no initials, use user name instead		Set UserInitials ""				# in case it was not defined before		Set TrimmingName "{User}"		# use this for the loop		Loop			If "{TrimmingName}" =~ /([a-z])®1[a-z.]*[ -](≈)®2/				Set UserInitials {UserInitials}{®1}				Set TrimmingName "{®2}"			Else If "{TrimmingName}" =~ /([a-z])®1[a-z.]*/				Set UserInitials {UserInitials}{®1}				Break			Else				Set UserInitials "{User}∂n∂t∂t∂t∂t∂t∂t∂t"				Break			End		End	End	# put the comment at the top of the change history	Begin		Echo -n "{Leader}∂t{Version}∂t{ChangeDate}∂t{UserInitials}∂t∂t"		WrapCommentText 65 "{Leader}∂t∂t∂t∂t∂t∂t∂t∂t∂t" < "{Comment}" || ∂			Echo -n "xxx put comment here xxx"		Echo	End > "{Window}.§"	# ••• The following stuff will need to be revisited in 2000 or so.	If "`Date -d`" =~ /≈([0-9]«4»)®1/		Set thisYear "{®1}"	End	Set lastYear "`Evaluate {thisYear} - 1`"	# When checking in during 1994, the copyright information should be formatted as follows:	#	# Original Copyright		New Copyright					Change Needed	# ------------------		-------------					-------------	#	# © 198x by Apple…			© 198x, 1994 by Apple…			append “, 1994”	# © 198x-198y by Apple…		© 198x-198y, 1994 by Apple…		append “, 1994”	# © 198x, 198y by Apple…	© 198x, 198y, 1994 by Apple…	append “, 1994”	#	# © 1990 by Apple…			© 1990, 1994 by Apple…			append “, 1994”	# © 198x-1990 by Apple…		© 198x-1990, 1994 by Apple…		append “, 1994”	# © 198x, 1990 by Apple…	© 198x, 1990, 1994 by Apple…	append “, 1994”	#	# © 1993 by Apple…			© 1993-1994 by Apple…			append “-1994”	# © 198x, 1993 by Apple…	© 198x, 1993-1994 by Apple…		append “-1994”	# © 198x-1993 by Apple…		© 198x-1994 by Apple…			replace “1993” with “1994”	# © 1990-1993 by Apple…		© 1990-1994 by Apple…			replace “1993” with “1994”	# © 198x, 1990-1993 by Apple…	© 198x, 1990-1994 by Apple…	replace “1993” with “1994”	#	Find • "{Window}"	Set Found 0	#	# Check if copyright is OK already.  This is not only faster in the common case,	# but it will also help us to avoid making changes later in the file past the	# header if the header is already correct.	#	Find /{thisYear} by Apple/ "{Window}" && Set Found 1	# Check for a copyright that ends with a 1980s date	#	# Original Copyright		New Copyright					Change Needed	# ------------------		-------------					-------------	# © 198x by Apple…			© 198x, 1994 by Apple…			append “, 1994”	# © 198x-198y by Apple…		© 198x-198y, 1994 by Apple…		append “, 1994”	# © 198x, 198y by Apple…	© 198x, 198y, 1994 by Apple…	append “, 1994”	If ¬{Found}		Replace /(198[0-9])®1 by Apple/ '®1, '{thisYear}' by Apple' "{Window}" && Set Found 1	End	# Check for a copyright that ends with a 90's date earlier than last year	#	# Original Copyright		New Copyright					Change Needed	# ------------------		-------------					-------------	# © 1990 by Apple…			© 1990, 1994 by Apple…			append “, 1994”	# © 198x-1991 by Apple…		© 198x-1991, 1993 by Apple…		append “, 1994”	# © 198x, 1990 by Apple…	© 198x, 1990, 1993 by Apple…	append “, 1994”	If ¬{Found}	 	Set beforeLastYear "`Evaluate {lastYear} - 1991`"		Replace /(199[0-{beforeLastYear}])®1 by Apple/ '®1, '{thisYear}' by Apple' "{Window}" && Set Found 1	End	# Check for a copyright that ends with “ {lastYear}” (note the space!)	#	# Original Copyright		New Copyright					Change Needed	# ------------------		-------------					-------------	# © 1993 by Apple…			© 1993-1994 by Apple…			append “-1994”	# © 198x, 1993 by Apple…	© 198x, 1993-1994 by Apple…		append “-1994”	If ¬{Found}		Replace / {lastYear} by Apple/ ' '{lastYear}-{thisYear}' by Apple' "{Window}" && Set Found 1	End	# Check for a copyright that ends with “-{lastYear}”	#	# Original Copyright		New Copyright					Change Needed	# ------------------		-------------					-------------	# © 198x-1993 by Apple…		© 198x-1994 by Apple…			replace “1993” with “1994”	# © 1990-1993 by Apple…		© 1990-1994 by Apple…			replace “1993” with “1994”	# © 198x, 1990-1993 by Apple…	© 198x, 1990-1994 by Apple…	replace “1993” with “1994”	If ¬{Found}		Replace /-{lastYear} by Apple/ '-'{thisYear}' by Apple' "{Window}"	End	# ••• End of year-dependent stuff	Exit 0End {somewhere}