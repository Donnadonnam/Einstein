<!-- Generated by Harlequin WebMaker 2.3.1 (16-Oct-1996)Macintosh Common Lisp Version 4.0 --><HTML> <HEAD><TITLE>Using the NewtonScript API to Record Sound</TITLE></HEAD><BODY><A NAME=HEADING277></A><CENTER>     <IMG BORDER="0" SRC="../../../../images/level3.gif" ALT="Title Banner"      ISMAP USEMAP="#level3">     <BR>     <MAP NAME="level3">     <!-- Find It -->     <AREA SHAPE="RECT" COORDS="7, 9, 69, 30" HREF="../../../../find.html">     <!-- Main -->     <AREA SHAPE="RECT" COORDS="432, 9, 492, 30" HREF="../../../../devworld.shtml">     </MAP><P><A HREF="NPG2-276.html"><IMG ALIGN = BOTTOM SRC = "graphics/prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="NPG2-2.html"><IMG ALIGN = BOTTOM SRC = "graphics/content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="NPG2-443.html"><IMG ALIGN = BOTTOM SRC = "graphics/index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="NPG2-278.html"><IMG ALIGN = BOTTOM SRC = "graphics/next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P><FONT SIZE=-1><DL><DT><A HREF="../../techinfo.html"><B>Newton Developer Technical Information:</B></A> <A HREF="NPG2-2.html"><B>Newton Programmer's Guide: 2.1 OS Addendum</B></A> / <BR><DD><A HREF="NPG2-262.html"><B>Chapter 7 - Sound</B></A> / <A HREF="NPG2-274.html"><B>Using Sound</B></A></DL></FONT><P><HR><BLOCKQUOTE><A NAME=HEADING277-0></A><H2><A NAME=MARKER-9-111></A>Using the NewtonScript API to Record Sound</H2> Because sound recording requires some user interface controls to start and stop the recording process, there is no single programmatic interface for recording equivalent to the <A HREF=NPG2-326.html#MARKER-9-212><EM>*</EM></A><CODE>PlaySound</CODE> function. However, there is a ready-made sound recording proto and slip that you can use to quickly add sound recording and playback capabilities to any application; for details, see the previous subsections, <A HREF=NPG2-275.html#MARKER-9-106>"Using the protoRecorderView"</A> and <A HREF=NPG2-276.html#MARKER-9-109>"Using the Built-in Sound Recorder Slip."</A><P> If you want to create your own sound recording interface and programmatically control everything, then you'll need to use the NewtonScript API directly, as described in this subsection.<P> To record sound programmatically, you must do these steps:<P><OL><LI>Create a new sound channel.<LI>Open the sound channel.<LI>Allocate a block of memory to hold the recorded sound samples.<LI>Schedule the recording.<LI>Start the recording.<LI>Finally, stop recording.</OL> This whole process is shown in <A HREF=#MARKER-9-112>Listing 7-1</A>.<P><B>Listing 7-1  <A NAME=MARKER-9-112></A>Sound input</B><P><PRE><P> // callback function passed to NewInputBlock below<P>MyCallback: func(state, result) beginif self.notdone then begin // test a flag to see if we're done   // if so, continue with another input block   local anotherSound := myChannel:NewInputBlock(MyCallback);   myChannel:Schedule(anotherSound);   endelse   // if we're done, then close the channel   myChannel:Close();end// sound input sample code; first initialize and open the channelmyChannel := protoSoundChannel:NewRecording();myChannel:Open();// good idea to create and schedule 2 input blocks initiallylocal mySound := myChannel:NewInputBlock(MyCallback);local anotherSound := myChannel:NewInputBlock(MyCallback)myChannel:Schedule(mySound);myChannel:Schedule(anotherSound); myChannel:Start(true);<P><P></PRE> You first create a new sound channel using the method <CODE><A HREF=NPG2-302.html#MARKER-9-162><EM>*</A>protoSoundChannel:<A HREF=NPG2-310.html#MARKER-9-179>*</A>NewRecording</EM></CODE>. This creates a sound channel that is properly initialized for recording. Next, open the sound channel by sending it the <CODE>Open</CODE> message. Then, create a new block of memory to hold the recorded samples by sending it the <A HREF=NPG2-309.html#MARKER-9-177><EM>*</EM></A><CODE>NewInputBlock</CODE> message, which returns a sound frame. The <CODE>samples</CODE> slot in this sound frame holds a virtual binary object (VBO) that is allocated for the sample data. This size of the VBO is determined by the value of the <CODE>inputBlockSize</CODE> slot in the sound channel, which defaults to 65536 bytes.<P> If you might need to record more than one buffer's worth of input data, it's a good idea to allocate and schedule two input sound frames initially, to provide double-buffering. This way, the next buffer is always ready immediately, if needed.<P> Next, schedule the recording by sending the sound channel the <A HREF=NPG2-313.html#MARKER-9-187><EM>*</EM></A><CODE>Schedule</CODE> message, passing the new sound frame as a parameter. Finally, you can start recording by sending the <A HREF=NPG2-316.html#MARKER-9-193><EM>*</EM></A><CODE>Start</CODE> message to the sound channel. After you send the <A HREF=NPG2-316.html#MARKER-9-193><EM>*</EM></A><CODE>Start</CODE> message, there will be about a half-second delay while the sound hardware powers up before recording starts.<P> The Sound Manager then records sound into the scheduled sound frame. Once the <CODE>samples</CODE> VBO is full, it calls the callback function object provided by the sound frame. Then, the Sound Manager looks to see if there is another scheduled sound frame to continue recording into, and if so, it continues recording into the next sound frame. It is your responsibility to ensure that enough sound frames are scheduled to keep recording.<P> <A NAME=MARKER-10-113></A>It is also your responsibility to keep track of which sound frames have been created and scheduled, and to update the size of the final input block (<CODE>samples</CODE> VBO) when the stop button is pressed. The return value of the <A HREF=NPG2-317.html#MARKER-9-195><EM>*</EM></A><CODE>Stop</CODE> method is a result frame <A HREF=NPG2-292.html#MARKER-9-140>(page 7-31)</A> that indicates where in the sample data recording was stopped, so you can adjust the size of the VBO in the last sound frame to be just large enough to hold the recorded samples. Here is an example of how to use the <A HREF=NPG2-323.html#MARKER-9-208><EM>*</EM></A><CODE>SetRecordingLength</CODE> method do this:<P><PRE><P> // stop recording and trim last VBO size<P>local result := myChannel:Stop();local sound := result.sound;local numSamples := result.index; sound:SetRecordingLength(numSamples, nil);<P><P></PRE><A NAME=HEADING277-44></A><H3><A NAME=MARKER-9-114></A>Setting the Input Gain</H3> For recording, you can specify an input gain, which is an amplification applied to the incoming signal. The input gain can have a value ranging from 0 to 255. If the input gain is 0, then the incoming signal is not amplified at all; if the input gain is 255, then the signal is amplified by an amount that the driver has determined to be a maximum desirable amount. The middle value of 128 is considered to be an "optimal" setting for normal use.<P> You can set the initial input gain by setting the <CODE>inputGain</CODE> slot of the <CODE><A HREF=NPG2-302.html#MARKER-9-162><EM>*</A>protoSoundChannel</EM></CODE>. After the channel is open, you can change the input gain by using the method <A HREF=NPG2-314.html#MARKER-9-189><EM>*</EM></A><CODE>SetInputGain</CODE>. The method <A HREF=NPG2-304.html#MARKER-9-167><EM>*</EM></A><CODE>GetInputGain</CODE> returns the current input gain of the channel.<P> The behavior of the input gain can seem non-intuitive. The signal that comes from the internal microphone on the MessagePad 2000 is a very weak one, and the system relies on the input gain to boost it to a level that you can hear. Thus, when you are using the internal microphone and you set the input gain to 0, the recording will be silent. <P> The signal that comes from the line-in jack, however, is much stronger. When the input gain is set to 0, the recording is quite loud, which you might not expect if you think about it as an input volume instead of an input gain. In both cases, the default value of 128 instructs the device to amplify the signal to an "optimal" level.<P> The system does not support a self-adjusting input gain.<P> <A NAME=MARKER-10-115></A>In the Recording slip of the Prefs application, there's a slider that lets the user adjust the input gain (Recording volume). If the <CODE>inputGain</CODE> slot of the sound channel is <CODE>nil</CODE>, this user preference setting is used (which is stored in the <CODE>inputGain</CODE> user configuration variable).<P></BLOCKQUOTE><HR><center><A HREF="NPG2-276.html"><IMG ALIGN = BOTTOM SRC = "graphics/prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="NPG2-2.html"><IMG ALIGN = BOTTOM SRC = "graphics/content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="NPG2-443.html"><IMG ALIGN = BOTTOM SRC = "graphics/index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="NPG2-278.html"><IMG ALIGN = BOTTOM SRC = "graphics/next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P><center><font size=-1><A HREF="NPG2-3.html">&copy; Apple Computer, Inc.</A><br>26 APR 1997<P><!--------------------------- Navigation Area ----------------------------------><BR><!-- Navigation Area --><BR><A HREF="reference to server cgi goes here"><IMG BORDER="0" SRC="../../../../images/nav.gif" WIDTH="500" HEIGHT="32" ALT="Navigation graphic, see text links" ISMAP USEMAP="#nav"></A><BR><P><A HREF="../../../../devworld.shtml">Main</A> | <A HREF="../../techinfo.html">Top of Section</A> | <A HREF="../../newtondev.shtml#WhatsNew">What's New</A> | <A HREF="http://www.apple.com/">Apple Computer, Inc.</A> |<A HREF="../../../../find.html">Find It</A> | <A HREF="../../feedback.html">Feedback</A> | <A HREF="../../../../help.html">Help</A></FONT><P></CENTER><!-- Don't forget to add the necessary links for each of these items. --><BR><MAP NAME="nav"><!-- client side map for www.apple.com nav.gif --><!-- Main --><AREA SHAPE="RECT" COORDS="9,6,70,25" HREF="../../../../devworld.shtml"><!-- Page One --><AREA SHAPE="RECT" COORDS="80,6,142,25" HREF="../../techinfo.html"><!-- What's New --><AREA SHAPE="RECT" COORDS="150,5,211,25" HREF="../../newtondev.shtml#WhatsNew"><!-- Apple Logo --><AREA SHAPE="RECT" COORDS="220,6,280,25" HREF="http://www.apple.com/"><!-- Find It --><AREA SHAPE="RECT" COORDS="290,5,350,26" HREF="../../../../find.html"><!-- Contact Us --><AREA SHAPE="RECT" COORDS="361,5,422,25" HREF="../../feedback.html"><!-- Help --><AREA SHAPE="RECT" COORDS="430,5,492,25" HREF="../../../../help.html"><!-- DEFAULT AREA NOT SUPPORTED BY CLIENT SIDE IMAGEMAPS! --></MAP><P></BODY></HTML> 